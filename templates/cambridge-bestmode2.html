<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">
    <script type="text/javascript" src="{{URL_PREFIX}}static/js/jquery.tipsy.js"></script>
    <link rel="stylesheet" type="text/css" href="{{URL_PREFIX}}static/css/transportation.css"> </style>
    <script type="text/javascript" src='{{URL_PREFIX}}static/js/transportation.js'></script>
    <link href='http://fonts.googleapis.com/css?family=EB+Garamond' rel='stylesheet' type='text/css'>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBZnvqy9HEpG-LAQwm_AxDOegMciI9jgP4&sensor=false&v=3.16"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-47879752-1', 'mit.edu');
      ga('send', 'pageview');

    </script>
    
    <script type="text/javascript">
    $('.container').css('width', '1600px');

    var scaleFactor = 0.92;
    var mapCenter = [-71.123625,42.372115];
    var labelXoffset = 140;
    var labelYoffset = 25;
    var drawSpeed = 20;
    var segments;
    var structuredOffset = false;
    var buildings;
    var gMap; 
    var dataValues;
    var blocks;
    var overlay;
    var neighborhoods;
    var cMap = {'walking':"#4dac26", 'transit': "#2b83ba", 'bicycling': "#fdae61", 'driving': "#d7191c"};
    var opacityScales={};

    $(window).load(function(){


        d3.json('{{URL_PREFIX}}static/data/Cambridge/transportation/neighborhoods.geojson', function(geojson2){
              neighborhoods = geojson2;              
              drawGoogleMap();
              initialize();

          d3.json('{{URL_PREFIX}}static/data/Cambridge/transportation/blocks_processed.geojson', function(blockgeojson){
              blocks = blockgeojson;

            d3.json('{{URL_PREFIX}}static/data/Cambridge/transportation/bestMode_values_blocks.json', function(values){
              dataValues = values; 
              initializeBlocksOverlay();
              initOpacityScales();

            });
        });
      });
    });


    function drawGoogleMap(){
      var mapStyles = [{"featureType":"poi","stylers":[{"visibility":"off"}]},{"stylers":[{"saturation":-70},{"lightness":37},{"gamma":1.15}]},{"elementType":"labels","stylers":[{"gamma":0.26},{"visibility":"off"}]},{"featureType":"road","stylers":[{"lightness":0},{"saturation":0},{"hue":"#ffffff"},{"gamma":0}]},{"featureType":"road","elementType":"labels.text.stroke","stylers":[{"visibility":"off"}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"lightness":20}]},{"featureType":"road.highway","elementType":"geometry","stylers":[{"visibility":"off"}]},{"featureType":"administrative.province","stylers":[{"visibility":"simplified"},{"lightness":-50}]}, {"featureType":"administrative.neighborhood","elementType":"labels","stylers":[{"visibility":"on"}, {"lightness":60}]},{"featureType":"administrative.province", "elementType":"labels.text","stylers":[{"lightness":20}]}];

      var mapOptions = {
        center: new google.maps.LatLng(42.378115,-71.1123625),
        zoom: 14,
        zoomControl: false,
        panControl:false,
        mapTypeControl: false,
        scaleControl: false,
        streetViewControl: false,
        overviewMapControl: false,
        disableDefaultUI:true,
        styles:mapStyles
      };

      gMap = new google.maps.Map(document.getElementById('mapContainer'),mapOptions);
    }

    function initOpacityScales(){
      var ranges = dataValues['ranges'];
      opacityScales['walking'] = d3.scale.linear().domain([ranges['walking'][0], ranges['walking'][1]]).range([0.2,0.9]);
      opacityScales['bicycling'] = d3.scale.linear().domain([ranges['bicycling'][0], ranges['bicycling'][1]]).range([0.2,0.9]);
      opacityScales['transit'] = d3.scale.linear().domain([ranges['transit'][0], ranges['transit'][1]]).range([0.2,0.9]);
      opacityScales['driving'] = d3.scale.linear().domain([ranges['driving'][0], ranges['driving'][1]]).range([0.2,0.9]);
    }

    function colorBlocks(nHood){
      var values = dataValues[nHood];
      svg.selectAll('.block')
        .attr('fill', function(d){
          if (values[d.id] != undefined){
            return cMap[values[d.id].bestMode]
          } else {return cMap['driving']}
        })
        .attr('fill-opacity', 0.5);
        // .attr('fill-opacity', function(d){
        //   if (values[d.id] != undefined) {
        //     console.log()
        //     if (values[d.id].bestMode != -1){
        //       opacityScales[values[d.id].bestMode](values[d.id].bestVal);
        //     }
        //   } else {return 0.5}
        //   });
    }

    function initializeBlocksOverlay(){
      overlay = new google.maps.OverlayView();

      overlay.onAdd = function (){
        var layer = d3.select(this.getPanes().overlayLayer).append("div")
          .attr('class','d3overlay');

          svg = layer.append('svg');

          svg.selectAll('.block')
            .data(blocks.features)
            .enter().append("path")
            .attr("class", "block")
            .attr("fill", 'blue')
            .attr("fill-opacity", 0.0)
            .attr("id", function(d){return d.id;})
            .attr("stroke", 'blue')
            .attr("stroke-opacity", 0.0)


          svg.selectAll('.nhood')
            .data(neighborhoods.features)
            .enter().append("path")
            .attr("class", "nhood")
            .attr("fill", 'white')
            .attr("fill-opacity", 0.0)
            .attr("id", function(d){return d.id;})
            .attr("stroke", 'red')
            .attr("stroke-opacity", 1.0)
            .on('click', function(d){colorBlocks(d.properties.N_HOOD);});

          overlay.draw = function(){
            var overlayProjection = this.getProjection();
            var projection = function(coordinates){
              var googleCoordinates = new google.maps.LatLng(coordinates[1], coordinates[0]);
              var pixelCoordinates = overlayProjection.fromLatLngToDivPixel(googleCoordinates);
              return [pixelCoordinates.x + 0, pixelCoordinates.y + 0];
            }
          var path = d3.geo.path().projection(projection);

          svg.selectAll('.block')
            .data(blocks.features)
            .attr("d",path);

          svg.selectAll('.nhood')
            .data(neighborhoods.features)
            .attr("d",path);
          

        }

        overlay.draw();
      }
      overlay.setMap(gMap);
    }

    </script>
    </head>

    <body>

      
    
      <div class='container'>

        <div class="title-container"> 
          <a id="logo" href="http://youarehere.cc">
                <img src="{{URL_PREFIX}}static/img/logo_png24.png" style="width: 50px">
          </a>
          <div class="title-text">
                <h1 class="title">
                    <span id="mapClass" class="title-keyword"> Cambridge </span> 
                </h1>
                <div class="subtitle">
                    What is the best mode of transport? <span style='color:#4dac26;'> walking</span>,<span style='color:#fdae61;'> bicycling </span>,<span style='color:#2b83ba;'> transit</span> or <span style='color:#d7191c;'> driving </span> ?
                    <span id="showMore"> ... more </span>
                </div>
          </div>
          <div class="spacer"></div>
        </div>

        <div id="mapContainer"></div>

          <div id="footer">
            <!--<img src="/static/img/logo.png" style="width: 40px;"/> -->
            This work is part of the <a href="http://youarehere.media.mit.edu">You Are Here</a> project
            <span class="footer-plus">+</span>
            <a href="http://socialcomputing.media.mit.edu"> The Social Computing Group </a>
            <span class="footer-plus">+</span>
            <a href="http://media.mit.edu"> MIT Media Lab </a>
          </div>
      
      <div id='essayBox'>
      <div id='essayBox-close' class="glyphicon glyphicon-remove"></div>
      <div id='essayContent'>
      <p>
            "When great trees fall,</br>
            rocks on distant hills shudder,</br>
            lions hunker down </br>
            in tall grasses,</br>
            and even elephants</br>
            lumber after safety.</br>
            </br>
            When great trees fall</br>
            in forests,</br>
            small things recoil into silence,</br>
            their senses</br>
            eroded beyond fear."</br>
            </br>
            -Maya Angelou
      </p>

      <p>
        Trees provide us shade, fresh air, and beauty.  They create places to be in, to lean on, and to pass through.  And they remind us of our essential connection with nature, and with one another.  Trees can make a city feel alive, and places with no trees can feel barren.  
      </p>

      <p>
        This map visualizes the approximate amount of greenery on the streets in and around the downtown area of Atlanta.  On the map, the relative amount of greenery at each point is represented by a marker's size and opacity.
      </p>

      <p> 
        To create this map, we crawled Google Street View images, and then ran a simple probabilistic classifier to approximate the amount of visible plant life for each street.  These maps are approximate, in part because of seasonal changes and weather conditions, yet they give us a sense of which streets are full of life. The histogram in the lower left-hand corner gives a distribution of street greenery.  The left-hand side of the histogram represents the number of streets with low levels of street greenery, and the right-hand side of the histogram represents the number of streets with a high levels of street greenery.  Clicking on a bar in the histogram shows all the streets at that level, and clicking on a street on the map will highlight where in the histogram that street belongs. 
      </p>

        <p style="color:#898989;"> Data Sources </p>
        <ol>
          <li><a href="https://developers.google.com/maps/documentation/streetview/">Google Maps StreetView Image API </a></li>
          <li><a href="http://www.atlantaregional.com/info-center/gis-data-maps">Atlanta Regional GIS Program </a></li>
        </ol>

      </div>
      </div> 
    </div>


      
    </body>
</html>
    