<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZnvqy9HEpG-LAQwm_AxDOegMciI9jgP4&libraries=geometry&sensor=false"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Raleway:200' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/static/css/bootstrap-responsive.min.css"/> 
    <link rel="stylesheet" type="text/css" href="/static/css/tipsy.css"/> 
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">
    <script type="text/javascript" src="/static/js/jquery.tipsy.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/GeoJSON.js"></script>
    <style type="text/css">

    html, body{
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Raleway', sans-serif;

    }

    #svgContainer {
        width: 100%;
        height: 100%;
        float:left;
        border-left: 5px;
    }

    #infoGraphic{
      position: absolute;
      height: 100%;
      width: 5%;
      left: 100%;
      margin-right: 2%;
      float:right;
      border-left: '1px';
      border-left-color:#000000; 
    }

    #drawer {
      left : 95%;
      float:right;
      position:absolute;
      background-color:'#093DDB';
      z-index: 2;
      top:2%;
    }


    #logo{
      left : 3%;
      float:left;
      position:absolute;
      z-index: 3;
      top:2%;
    }

    #paneContent{
      height:100%;
      width:100%
    }
    #tabcontent_1{
      height:100%;
      width:100%
    }

    #tabcontent_2{
      height:100%;
      width:100%
    }

    #tabcontent_3{
      height:100%;
      width:100%
    }

    #auditForm{
      width:95%;
      height:75%;
      z-index: 1;
    }

    #street-view{
      width:95%;
      height:60%%;
    }

/*    .accidents, .accidents svg {
      position: absolute;
    }

    .accidents svg {
      width: 60px;
      height: 20px;
      padding-right: 100px;
      font: 10px sans-serif;
    }*/
        




   </style>
   <script type="text/javascript">
   var map;
   var canvasLayer;
   var context;
   var accidentData;

   var bikeFlag = false;
   var bikeLayer;
   var activeTab;
   var vertActiveTab;
   var activeTabContent;
   var pano;
   var chartData = [];
   var chartDrawn = false;
   var allClusters = {};
   var finalClusters = {};
   var projection = d3.geo.mercator();
   var path = d3.geo.path().projection(projection); 
   var geoJSON;
   var greenData;
   var scaleFactor = 0.98;
   var svg;
   var points = [];
   var drawIndex = 0;
   var maxWidth = 1;
   var maxPoints;
   var currentDrawPoints;

   $(window).load(function(){

       // map = new google.maps.Map(document.getElementById("map"), {
    //     zoom: 12,
    //     center: new google.maps.LatLng(41.93202,-87.715044),
    //     mapTypeId: google.maps.MapTypeId.ROAD,
    //     streetViewControl: false,
    //     zoomControl: false,
    //     panControl:false
    //   });



  $.getJSON('/static/data/Cambridge/boundary.geojson', function(geojson){
    geoJSON = geojson;
    setProjection();
    drawMap();

    $.getJSON('/static/data/Cambridge/greenery.geojson', function(greenGeoJSON){
      //points = data;
      greenData = greenGeoJSON;      
      // googleMapsVector = new GeoJSON(geoJSON);

      // for (var i = 0; i < data.length; i++){
      //   var latlng = new google.maps.LatLng(parseFloat(data[i].lat), parseFloat(data[i].lng));
      //   for (var j = 0; j<googleMapsVector.length; j++){
      //     var shp = googleMapsVector[j];
      //     var isInside = google.maps.geometry.poly.containsLocation(latlng, shp);
      //     if (isInside) {
      //       points.push(data[i]);
      //     }
      //   }
      // }
      // maxPoints = points.length;
      drawCircles();  
        
    });
  });
     

     $("#chart").hide();

     activeTab = $('#tab_1');
     activeTabContent = $("#tabcontent_1");
     $("#tabcontent_2").hide();

     //$("#map").show();
     $("#tab_2").click(function(){
        console.log("here")
        $('#tab_2').addClass("active");
        $('#tab_1').removeClass("active");
        $("#tabcontent_1").hide()
        $("#tabcontent_2").show();
        $("#chart").show();
        drawChart();
     });

     $("#tab_1").click(function(){
      $('#tab_2').removeClass("active");
      $('#tab_1').addClass("active");
      $("#tabcontent_1").show()
      $("#tabcontent_2").hide();
      $("#chart").hide();
     });

     $('#drawer').click(function(){
            var width = $(window).width(); var height = $(window).height();
            $('#svgContainer').empty();
            console.log('click');

            if (!infoGraphToggle){
                console.log("here1");
                $('#infoGraphic').show();


                
                $('#svgContainer').width(width * 0.7);
                $('#infoGraphic').css('left', width * 0.7);
                $('#infoGraphic').css('width', width * 0.3);
                $('#chart').css('width', $('#infoGraphic').width());
                $('#chart').css('height', $('#infoGraphic').height() * 0.95);


                
                $('#drawer').css('left', width * 0.7);
                $('#button-icon').removeClass('glyphicon glyphicon-chevron-left');
                $('#button-icon').addClass('glyphicon glyphicon-chevron-right');
            } else {
                console.log("here2");
                $('#infoGraphic').hide();
                $('#svgContainer').width(width * 1.0);
                $('#infoGraphic').css('left', width * 1.0);
                $('#infoGraphic').css('width', width * 0);
                $('#drawer').children().find('span').css('class','glyphicon glyphicon-arrow-left');
                $('#chart').empty();
                $("#title").empty();
                $('#button-icon').removeClass('glyphicon glyphicon-chevron-right');
                $('#button-icon').addClass('glyphicon glyphicon-chevron-left');
                $('#drawer').css('left', width * 0.95);
            }

            infoGraphToggle = !infoGraphToggle;
            setProjection();
            drawMap();
            //drawCircles();
            // console.log('end chart');            

        });

    
  });

function setProjection(){ 
  projection.scale(1)
    .translate([0, 0]);

  width = $("#svgContainer").width(); height = $("#svgContainer").height();
  console.log(width, height);
  var b = path.bounds(geoJSON),
    s = scaleFactor / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
    t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];
  projection.scale(s).translate(t);
  projection([-87.715044,41.93202]);
}




function drawChart(){
  var chartHeight = $("#chart").height();
  var chartWidth = $("#chart").width();

  var maxBarWidth = chartWidth-2; var barHeight = 20;
  var svg = d3.select("#chart").append("svg")
        .attr("width", chartWidth)
        .attr("height", chartHeight);


  var barLabel = function(d) { return d['name']; };
  var barValue = function(d) { return d['numAccidents']; };
  
  var yScale = d3.scale.ordinal().domain(d3.range(0, chartData.length)).rangeBands([0, chartData.length * barHeight]);
  var y = function(d, i) { return yScale(i); };
  var x = d3.scale.linear().domain([0, d3.max(chartData, barValue)]).range([0, maxBarWidth]);

  var chart = d3.select('#chart').append("svg")
    .attr("width", chartWidth)
    .attr("height", chartHeight)
  var gridContainer = chart.append('g')


  svg.selectAll("rect")
      .data(chartData)
    .enter().append("rect")
      .attr("y", y)
      .attr('height', 5)
      .attr("fill", "#FA8602")
      .attr("stroke", "white")
      .attr('opacity',0.3)
      .on('mouseover', function(d){
        d3.select(this).attr('opacity', 1.0);
      })
      .on('mouseout', function (){
        d3.select(this).attr('opacity',0.3);
      })
      .transition()
      .ease("elastic")
        .duration(1000)
        .attr("x", 0)
        .attr('width', function(d) { return x(barValue(d)); });
  
  svg.selectAll("circle")
    .data(chartData)
    .enter().append("circle")
      .attr("cy",y)
      .attr("cx", function(d) { return x(barValue(d)); })
      .attr("r", 3)
      .attr("fill","#FA8602" );
      $('svg rect').tipsy({ 
          gravity: 's', 
          fade:true,
          html: true, 
          title: function() {
            var d = this.__data__.name;
            var val = this.__data__.numAccidents;
            return '<p style="#FA8602">' + d + ', # Accidents =  <span style="#FA8602">' + val + '</span></p>'; 
          }
        });


}


  function toggleStreetView(latlng, show){
        
        if (show){
          var panoramaOptions = {
            position: latlng,
            pov: {
              heading: 0,
              pitch: -10,
              zoom: 1
            },
            //map: map,
            navigationControl: false,
            enableCloseButton: false,
            addressControl: false,
            linksControl: false,
            panControl:false,
            zoomControl:false
        };
       
        pano = new google.maps.StreetViewPanorama(document.getElementById("street-view"), panoramaOptions);
        } else{
          $('#street-view').html('');
        }
  }

function drawMap(){
  svg = d3.select("#svgContainer").append("svg");

  svg.selectAll("path")
    .data(geoJSON.features)
   .enter().append("path")
    .attr("d", path)
    .attr("fill", "none")
    .attr("stroke-opacity", 0.1)
    .attr("stroke", "black");
}

function blur() {
  filter.attr("stdDeviation", this.value / 5);
}

function drawController(){

  if (drawIndex <= maxPoints){

    if (points.length > 1000){
      currentDrawPoints = points.splice(0,1000);
      drawIndex += currentDrawPoints.length;
      console.log("middle",drawIndex);
      setTimeout(drawCircles, 200);
    } else {
        drawIndex += points.length;
        currentDrawPoints = points;
        console.log("end", drawIndex);
        setTimeout(drawCircles,200);
    }
  }
}

function drawCircles(){

  var opValue = function(d) { return d.properties.opacity; };
  var opScale = d3.scale.sqrt().domain([0, d3.max(greenData.features, opValue)]).range([0.0, 1]); 


  var radValue = function(d){ return d.properties.radius;};
  var radiusScale = d3.scale.sqrt().domain([0, d3.max(greenData.features, radValue)]).range([0.05, 2.0]); 

  var filter = svg.append("defs")
      .append("filter")
        .attr("id", "blur")
      .append("feGaussianBlur")
        .attr("stdDeviation", 1.2);

  g = svg.append('g');

  g.selectAll('path')
    .data(greenData.features)
    .enter().append("circle")
    .attr("class", "greens")
    .attr("r", function(d,i){ return radiusScale(d.properties.radius);})
    .attr('cx', function (d) {       
      return projection([parseFloat(d.geometry.coordinates[1]), parseFloat(d.geometry.coordinates[0])])[0]; 
    })
    .attr('cy', function (d) {
      return projection([parseFloat(d.geometry.coordinates[1]), parseFloat(d.geometry.coordinates[0])])[1]; 
    })
    .attr("fill", "#2DBA20")
    .attr("stroke", "#2DBA20")
    .attr("opacity", function(d,i){return opScale(d.properties.opacity);});
    // .on('mouseover', function(d){
    //   var latlng = new google.maps.LatLng(d['lat'], d['lng']);
    //   toggleStreetView(latlng, true);
    //   d3.select(this)
    // })
    // .on('mouseout', function(d){
    //   $("#address").text('Pick a circle');
    //   var latlng = new google.maps.LatLng(d['lat'], d['lng']);
    //   toggleStreetView(latlng, false);

    //   d3.select(this)
    //     .attr("fill", "#2DBA20"); 
    // })
    //.attr("filter", "url(#blur)");

    // if (drawIndex < maxPoints){
    //   currentDrawPoints = [];
    //   setTimeout(drawController,200);
    // }
    
  
}
  




  

    

   

   
    //google.maps.event.addDomListener(window, 'load', init);
   </script>
  </head>
  <body>
      <img id="logo" src="/static/img/logo.png">
      <div id="drawer">
          <svg height='50' width='50' style="z-index:1">
              <circle cx="25" cy="25" r="15"  stroke-opacity="0.0" fill="#2DBA20" fill-opacity="0.5" />
          </svg>
          <i id='button-icon' class="glyphicon glyphicon-chevron-left" style="position:absolute; left:35%; top:33%; z-index:2"></i>
        </div>
      <div id="infoGraphic">
        <br></br>
        <p id = 'title' align="center"  style="color:#2DBA20;font-size:15pt"> Street Greenery - Cambridge, MA</p>
         
        <br></br>
        <div id="tabConatiner">
          <ul id="infoTabs" class="nav nav-tabs">
            <li  id="tab_1" class="active" ><a href="#" style="color:#2DBA20;">Street View</a></li>
            <li id="tab_2" ><a  href="#" style="color:#2DBA20;">Street Graph</a></li>
          </ul>
        </div>

        <div id="paneContent">
          <div id="tabcontent_1">
            <p id="address" align="left" style="color:#2DBA20;font-size:10pt">Hover over an point to explore.</p>
            <div id="street-view" > </div>
            <br></br>
            <p style="color:#FA8602;font-size:10pt"> Data Source: Google StreetView </p>
          </div>
          <div id="tabcontent_2" >

            <p align="center" style="color:#FA8602;font-size:11pt"> Greenery by Street </p>
            <p id="chartTitle" align="center" style="color:#2DBA20;font-size:11pt"> </p>
            <div id="chart" style="width:95%; height:90%;"> </div>
          </div>
          
        </div>


      </div>
        
        <div id="svgContainer"></div>
</body>
</html>
    