<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">
    <script type="text/javascript" src="{{URL_PREFIX}}static/js/jquery.tipsy.js"></script>
    <link rel="stylesheet" type="text/css" href="{{URL_PREFIX}}static/css/transportation.css"> </style>
    <script type="text/javascript" src='{{URL_PREFIX}}static/js/transportation.js'></script>
    <link href='http://fonts.googleapis.com/css?family=EB+Garamond' rel='stylesheet' type='text/css'>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">


    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-47879752-1', 'mit.edu');
      ga('send', 'pageview');

    </script>
    
    <script type="text/javascript">
    $('.container').css('width', '1000px');
    var scaleFactor = 1.0;
    var mapCenter = [-71.123625,42.372115];
    var labelXoffset = 140;
    var labelYoffset = 25;
    var drawSpeed = 20;
    var segments;
    var dataValues;
    var structuredOffset = false;
    var buildings;
    var blurConstant = 0.3;
    var cmap = {'walking':"#4dac26", 'transit': "#2b83ba", 'bicycling': "#fdae61", 'driving': "#d7191c"};
    var opacityScales={};
    var centerCircle;
    var previousBlock;
    var originID;

    $(window).load(function(){
      jQuery.getJSON('{{URL_PREFIX}}static/data/Cambridge/boundary.geojson', function(geojson){
            geoJSON = geojson;
            setProjection();
            drawMap();
            initialize();

        d3.json('{{URL_PREFIX}}static/data/Cambridge/transportation/block_groups_processed.geojson', function(geojson2){
              buildings = geojson2;
              drawBlocks();

          d3.json('{{URL_PREFIX}}static/data/Cambridge/transportation/bestMode_values2.json', function(values){
              dataValues = values; 
              initOpacityScales();
              var numBlocks = buildings.features.length;
              var randomBlock = Math.floor(Math.random() * numBlocks) + 1;
              originID = randomBlock;
              processBlocks(randomBlock);
          });
        });
      });
    });

    function initOpacityScales(){
      var ranges = dataValues['ranges'];
      opacityScales['walking'] = d3.scale.linear().domain([ranges['walking'][0], ranges['walking'][1]]).range([0.3,1.0]);
      opacityScales['bicycling'] = d3.scale.linear().domain([ranges['bicycling'][0], ranges['bicycling'][1]]).range([0.3,1.0]);
      opacityScales['transit'] = d3.scale.linear().domain([ranges['transit'][0], ranges['transit'][1]]).range([0.3,1.0]);
      opacityScales['driving'] = d3.scale.linear().domain([ranges['driving'][0], ranges['driving'][1]]).range([0.3,1.0]);
    }

    function initHandlers(){

      if (previousBlock != undefined){
        d3.select(previousBlock).attr('stroke','gray').attr('stroke-opacity',0.0);
      }
      $('.controlBlock').click(function(){
        var this_id = $(this).attr('id');
        originID = this_id;
        previousBlock = d3.select(this);
        processBlocks(this_id);      
        var areas = dataValues[this_id]['areas'];
        $('#dataSentence').css('display','inline');
        $('#driving_value').html(areas['driving'].toFixed(1) + '%');
        $('#transit_value').html(areas['transit'].toFixed(1) + '%');
        $('#bicycling_value').html(areas['bicycling'].toFixed(1) + '%');
        $('#walking_value').html(areas['walking'].toFixed(1) + '%');
      });

      $('.controlBlock').on('mouseover', function(){
        var this_id = $(this).attr('id');
        if (dataValues[originID][this_id]['bestVal'] != undefined){
          $('#hover_value').css('display', 'inline');
          $('#hover_value').offset({left:$(this).offset().left, top: $(this).offset().top + 10});
          $('#hover_value').html(convertTime(dataValues[originID][this_id]['bestVal']) + ' by ' + dataValues[originID][this_id]['bestMode']);
        } else {
          $('#hover_value').css('display', 'none');
        } 
      });

      $('.controlBlock').on('mouseout', function(){
        $('#hover_value').css('display','none');
      });
    }

    function processBlocks(this_id){
      svg.selectAll('.block').each(function(){
          var block_id = $(this).attr('id');
          if (block_id != this_id){
            
            var bestMode = dataValues[this_id][block_id]['bestMode'];
            var bestVal = dataValues[this_id][block_id]['bestVal'];
            var colorValue = cmap[bestMode];
            d3.select(this)
              .attr('fill', colorValue)
              .attr('fill-opacity',opacityScales[bestMode](bestVal))

          } else {
            d3.select(this)
              .attr('fill',cmap['walking'])
              .attr('fill-opacity',0.5)
              .each(function(d){
                drawCenterCircle(d.properties.center[0], d.properties.center[1]);
              });
          }
          
        });
    }

    function convertTime(timeInSeconds){
      var minutes = Math.round(timeInSeconds / 60);
      var seconds = timeInSeconds % 60;
      return minutes + ' minutes ' + seconds + ' seconds';
    }

    function drawBlocks(){

      var filter = svg.append("defs")
        .append("filter")
          .attr("id", "blur")
        .append("feGaussianBlur")
          .attr("stdDeviation", blurConstant);

      var buildingsPaths = svg.selectAll(".block")
          .data(buildings.features)
          .enter().append("path")
          
          .attr("class", "block")
          .attr("fill", 'white')
          .attr("fill-opacity", 1.0)
          .attr("id", function(d){return d.id;})
          .attr("d",path)
          .attr("stroke", 'black')
          .attr("stroke-opacity", 0.0);

      var controlBlocks = svg2.selectAll(".controlBlock")
          .data(buildings.features)
          .enter().append("path")
          
          .attr("class", "controlBlock")
          .attr("fill", 'white')
          .attr("fill-opacity", 0.0)
          .attr("id", function(d){return d.id;})
          .attr("d",path)
          .attr("stroke", 'gray')
          .attr("stroke-opacity", 0.0);

      centerCircle = svg2.selectAll('.centerCircle')
          .data(buildings.features)
          .enter().append('text')
          .text("X")
          .attr('class','centerCircle');

      initHandlers();
    } 

    function drawCenterCircle(lng,lat){
      svg2.select('.centerCircle')
        .attr('dx', function(d){ 
          return projection([lng,lat])[0]})
        .attr('dy', function(d){return projection([lng,lat])[1]});
    }


    </script>
    </head>

    <body>
      <div class='container'>
        <div class="title-container"> 
          <a id="logo" href="http://youarehere.cc">
                <img src="{{URL_PREFIX}}static/img/logo_png24.png" style="width: 50px">
          </a>
          <div class="title-text">
                <h1 class="title">
                    <span id="mapClass" class="title-keyword"> Cambridge </span> 
                </h1>
                <div class="subtitle">
                    What is the best mode of transport: <span style='color:#fdae61;'> bicycling </span>,<span style='color:#2b83ba;'> transit</span>,<span style='color:#4dac26;'> walking</span> or <span style='color:#d7191c;'> driving </span> ?
                    <span id="showMore"> ... more </span>
                </div>
          </div>
          <div class="spacer"></div>
        </div>

        <div id='mainframe'>
          <div id="svgContainer">
<!--             <i style="position: absolute; left: 500px; top:250px;" class="fa fa-spinner fa-spin fa-3x"></i> -->
          </div>
          <img id='building_layer' src="{{URL_PREFIX}}static/img/transportation/cambridge3.png">
          <div id="svgControlContainer"></div>
          <p id='hover_value'></p>
      </div>

          <div id="footer">
            <!--<img src="/static/img/logo.png" style="width: 40px;"/> -->
            This work is part of the <a href="http://youarehere.media.mit.edu">You Are Here</a> project
            <span class="footer-plus">+</span>
            <a href="http://socialcomputing.media.mit.edu"> The Social Computing Group </a>
            <span class="footer-plus">+</span>
            <a href="http://media.mit.edu"> MIT Media Lab </a>
          </div>

        <div id='textContainer'>
          
          <p id='dataSentence'> From this location, <span id='driving' style="color:#d7191c"> <span id='driving_value'> </span> of the city is best reached by car </span>,</br>
          <span id='bicycling' style="color:#fdae61"> <span id='bicycling_value'> </span> by bicycle </span>, <span id='transit' style="color:#2b83ba" > <span id='transit_value'> </span> by public transit </span>, and </br>
          <span id='walking' style="color:#4dac26" > <span id='walking_value'> </span> by walking </span>
           </p>
          </br>
          </br>
          <p>Click on the map to explore travel efficiencies in the city.</p>
        </div>

          <div id='essayBox'>
      <div id='essayBox-close' class="glyphicon glyphicon-remove"></div>
      <div id='essayContent'>
      <p>
            "When great trees fall,</br>
            rocks on distant hills shudder,</br>
            lions hunker down </br>
            in tall grasses,</br>
            and even elephants</br>
            lumber after safety.</br>
            </br>
            When great trees fall</br>
            in forests,</br>
            small things recoil into silence,</br>
            their senses</br>
            eroded beyond fear."</br>
            </br>
            -Maya Angelou
      </p>

      <p>
        Trees provide us shade, fresh air, and beauty.  They create places to be in, to lean on, and to pass through.  And they remind us of our essential connection with nature, and with one another.  Trees can make a city feel alive, and places with no trees can feel barren.  
      </p>

      <p>
        This map visualizes the approximate amount of greenery on the streets in and around the downtown area of Atlanta.  On the map, the relative amount of greenery at each point is represented by a marker's size and opacity.
      </p>

      <p> 
        To create this map, we crawled Google Street View images, and then ran a simple probabilistic classifier to approximate the amount of visible plant life for each street.  These maps are approximate, in part because of seasonal changes and weather conditions, yet they give us a sense of which streets are full of life. The histogram in the lower left-hand corner gives a distribution of street greenery.  The left-hand side of the histogram represents the number of streets with low levels of street greenery, and the right-hand side of the histogram represents the number of streets with a high levels of street greenery.  Clicking on a bar in the histogram shows all the streets at that level, and clicking on a street on the map will highlight where in the histogram that street belongs. 
      </p>

        <p style="color:#898989;"> Data Sources </p>
        <ol>
          <li><a href="https://developers.google.com/maps/documentation/streetview/">Google Maps StreetView Image API </a></li>
          <li><a href="http://www.atlantaregional.com/info-center/gis-data-maps">Atlanta Regional GIS Program </a></li>
        </ol>

      </div>
      </div>
        </div>
    </body>
</html>
    